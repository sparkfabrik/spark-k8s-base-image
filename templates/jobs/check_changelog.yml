.check-changelog-base:
  script:
    # Safeguard to make the job actually run when at least one of the vars is set.
    - |
      if ([ -z "$SRC_BRANCH" ] || [ -z "$COMPARE_WITH" ]) && [ -z "$CI_COMMIT_TAG" ]; then
        echo 'SRC_BRANCH and COMPARE_WITH or CI_COMMIT_TAG are empty, bailing out.'
        echo "SRC_BRANCH=$SRC_BRANCH"
        echo "COMPARE_WITH=$COMPARE_WITH"
        echo "CI_COMMIT_TAG=$CI_COMMIT_TAG"
        exit 0
      fi
    # If the branch is a fix the check will be skipped
    - |
      if [ -n "$(echo "${SRC_BRANCH}" | grep -E "^fix\/.+")" ]; then
        echo 'Found fix/.+ branch name, bailing out.'
        exit 0
      fi
    # If the pipeline is running for a tag, we check if the tag is present in the changelog
    # otherwise the CHANGELOG.md should be edited
    - |
      if [ -n "${CI_COMMIT_TAG}" ]; then
        echo "Checking presence of $CI_COMMIT_TAG in CHANGELOG.md"
        grep "${CI_COMMIT_TAG}" CHANGELOG.md || exit_code=$?
      else
        echo "Checking if CHANGELOG.md has been modified in the branch ${SRC_BRANCH}"
        cd ${CI_PROJECT_DIR}
        git fetch origin ${COMPARE_WITH}:refs/remotes/origin/${COMPARE_WITH}
        git diff --name-only remotes/origin/${SRC_BRANCH}..remotes/origin/${COMPARE_WITH} | grep CHANGELOG.md >/dev/null || exit_code=$?
      fi
    - |
      if [ ${exit_code:-0} -ne 0 ]; then
        echo ah... ah... ah...
        echo https://i.imgflip.com/5gp2wa.gif
        exit 1
      fi

.check-changelog:
  variables:
    SRC_BRANCH: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
    COMPARE_WITH: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
  extends:
    - .check-changelog-base

# This job that should be used on the standard pipelines (no merge request pipelines)
.check-changelog-standard-pipelines:
  variables:
    SRC_BRANCH: $CI_COMMIT_BRANCH
    COMPARE_WITH: $CI_DEFAULT_BRANCH
  extends:
    - .check-changelog-base
