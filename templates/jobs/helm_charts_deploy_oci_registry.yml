# Helm push: https://helm.sh/docs/helm/helm_push/
# Helm and OCI registries: https://helm.sh/docs/topics/registries/
# This Gitlab job template enables the push of an Helm Chart on the specified OCI registry.
# Variables to configure to use the job template:
#   OCI_HOST: The host of the OCI registry (e.g.: `europe.pkg.dev`)
#   OCI_REGISTRY: The name of the OCI registry (e.g.: `my-project/my-registry`)
#   CHART: The name of the Helm Chart (e.g.: `my-awesome-app`)

.deploy_to_oci_registry:
  script:
    - echo "Deploy to OCI registry"
    - helm package .
    - helm push ${CHART}-${CI_COMMIT_TAG}.tgz oci://${OCI_HOST}/${OCI_REGISTRY}
  rules:
    - if: $CI_COMMIT_TAG
